name: CI

on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  Build&Push:
    runs-on: runner
    container:
      image: codeberg.org/eoelab/cenv:zig
    steps:
      - run: apt-get update --yes && apt-get install --yes git twine python3-venv python3-build python3-setuptools python3.13-dev       
      - run: git clone https://codeberg.org/eoelab/loaderx.git
      - run: |
          cd loaderx
          zig build -Dpython-version=python3.13 -p loaderx
          python3 -m build

      - run: |
          cd loaderx
          twine upload --verbose --repository testpypi dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TEST_PAT }}
      - run: |
          cd loaderx
          twine upload --verbose dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_PAT }}